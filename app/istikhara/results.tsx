import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  TouchableOpacity,
  Alert,
  Share,
  Dimensions,
} from 'react-native';
import { useLocalSearchParams, Stack, useRouter } from 'expo-router';
import { createMaterialTopTabNavigator } from '@react-navigation/material-top-tabs';
import { IstikharaData } from '../../types/istikhara';
import * as Print from 'expo-print';
import * as Sharing from 'expo-sharing';
import * as Haptics from 'expo-haptics';

// Import tab components
import OverviewTab from '../../components/istikhara/tabs/OverviewTab';
import PersonalityTab from '../../components/istikhara/tabs/PersonalityTab';
import CareerTab from '../../components/istikhara/tabs/CareerTab';
import BlessedDayTab from '../../components/istikhara/tabs/BlessedDayTab';
import SpiritualTab from '../../components/istikhara/tabs/SpiritualTab';

const Tab = createMaterialTopTabNavigator();
const { width } = Dimensions.get('window');

export default function IstikharaResults() {
  const params = useLocalSearchParams();
  const router = useRouter();
  const [data, setData] = useState<IstikharaData | null>(null);

  useEffect(() => {
    // Parse the data from route params
    if (params.data && typeof params.data === 'string') {
      try {
        const parsedData = JSON.parse(params.data);
        setData(parsedData);
      } catch (error) {
        console.error('Failed to parse result data:', error);
        Alert.alert('Error', 'Failed to load results', [
          { text: 'OK', onPress: () => router.back() },
        ]);
      }
    }
  }, [params.data]);

  if (!data) {
    return (
      <View style={styles.loadingContainer}>
        <Text style={styles.loadingText}>Loading results...</Text>
      </View>
    );
  }

  const elementColor = getElementColor(data.burujProfile.element);

  const handleExport = async () => {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);

    try {
      const html = generatePDFContent(data, params.personName as string, params.motherName as string);
      const { uri } = await Print.printToFileAsync({ html });

      if (await Sharing.isAvailableAsync()) {
        await Sharing.shareAsync(uri, {
          mimeType: 'application/pdf',
          dialogTitle: 'Share Istikhara Results',
        });
      } else {
        Alert.alert('Success', 'PDF saved successfully!');
      }

      await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Success);
    } catch (error) {
      console.error('Export error:', error);
      Alert.alert('Export Error', 'Failed to export results as PDF');
      await Haptics.notificationAsync(Haptics.NotificationFeedbackType.Error);
    }
  };

  const handleShare = async () => {
    await Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);

    try {
      const message = `
üåô Istikharah al-AsmƒÅ' Results

Person: ${params.personName}
Mother: ${params.motherName}

Buruj Sign: ${data.burujProfile.sign.en} (#${data.burujProfile.buruj_number})
Element: ${data.burujProfile.element}
Planet: ${data.burujProfile.planet}

Abjad Total: ${data.combinedTotal}
Dhikr Count: ${data.repetitionCount}

Generated by AsrƒÅr Everyday
      `.trim();

      await Share.share({
        message,
        title: 'Istikhara Results',
      });
    } catch (error) {
      console.error('Share error:', error);
    }
  };

  return (
    <>
      <Stack.Screen
        options={{
          title: 'Istikhara Results',
          headerStyle: {
            backgroundColor: '#1a1a2e',
          },
          headerTintColor: '#ffffff',
          headerRight: () => (
            <View style={styles.headerButtons}>
              <TouchableOpacity onPress={handleShare} style={styles.headerButton}>
                <Text style={styles.headerButtonText}>üì§</Text>
              </TouchableOpacity>
              <TouchableOpacity onPress={handleExport} style={styles.headerButton}>
                <Text style={styles.headerButtonText}>üìÑ</Text>
              </TouchableOpacity>
            </View>
          ),
        }}
      />

      <Tab.Navigator
        screenOptions={{
          tabBarActiveTintColor: elementColor,
          tabBarInactiveTintColor: '#8892b0',
          tabBarIndicatorStyle: {
            backgroundColor: elementColor,
            height: 3,
          },
          tabBarStyle: {
            backgroundColor: '#1a1a2e',
          },
          tabBarLabelStyle: {
            fontSize: 12,
            fontWeight: '600',
            textTransform: 'none',
          },
          tabBarScrollEnabled: true,
          tabBarItemStyle: {
            width: 'auto',
            minWidth: 90,
          },
        }}
      >
        <Tab.Screen name="Overview">
          {() => <OverviewTab data={data} elementColor={elementColor} />}
        </Tab.Screen>
        <Tab.Screen name="Personality">
          {() => <PersonalityTab data={data} elementColor={elementColor} />}
        </Tab.Screen>
        <Tab.Screen name="Career">
          {() => <CareerTab data={data} elementColor={elementColor} />}
        </Tab.Screen>
        <Tab.Screen name="Blessed Day">
          {() => <BlessedDayTab data={data} elementColor={elementColor} />}
        </Tab.Screen>
        <Tab.Screen name="Spiritual">
          {() => <SpiritualTab data={data} elementColor={elementColor} />}
        </Tab.Screen>
      </Tab.Navigator>
    </>
  );
}

function getElementColor(element: string): string {
  const colors: Record<string, string> = {
    'Fire': '#ef4444',      // Red
    'Earth': '#84cc16',     // Green
    'Air': '#06b6d4',       // Cyan
    'Water': '#3b82f6',     // Blue
  };
  return colors[element] || '#e94560';
}

function generatePDFContent(data: IstikharaData, personName: string, motherName: string): string {
  const { burujProfile, personTotal, motherTotal, combinedTotal, repetitionCount } = data;

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Istikhara Results</title>
  <style>
    body {
      font-family: 'Helvetica', 'Arial', sans-serif;
      padding: 40px;
      color: #333;
    }
    h1 {
      color: #1a1a2e;
      border-bottom: 3px solid #e94560;
      padding-bottom: 10px;
    }
    h2 {
      color: #e94560;
      margin-top: 30px;
    }
    .info-section {
      margin: 20px 0;
      padding: 15px;
      background-color: #f5f5f5;
      border-radius: 8px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
    }
    .label {
      font-weight: bold;
    }
    ul {
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <h1>üåô Istikharah al-AsmƒÅ' Results</h1>
  
  <div class="info-section">
    <div class="info-row">
      <span class="label">Person's Name:</span>
      <span>${personName}</span>
    </div>
    <div class="info-row">
      <span class="label">Mother's Name:</span>
      <span>${motherName}</span>
    </div>
    <div class="info-row">
      <span class="label">Date:</span>
      <span>${new Date().toLocaleDateString()}</span>
    </div>
  </div>

  <h2>Buruj Profile</h2>
  <div class="info-section">
    <div class="info-row">
      <span class="label">Sign:</span>
      <span>${burujProfile.sign.en} (${burujProfile.sign.arabic})</span>
    </div>
    <div class="info-row">
      <span class="label">Number:</span>
      <span>#${burujProfile.buruj_number}</span>
    </div>
    <div class="info-row">
      <span class="label">Element:</span>
      <span>${burujProfile.element}</span>
    </div>
    <div class="info-row">
      <span class="label">Planet:</span>
      <span>${burujProfile.planet}</span>
    </div>
  </div>

  <h2>Abjad Numerology</h2>
  <div class="info-section">
    <div class="info-row">
      <span class="label">Person Total:</span>
      <span>${personTotal}</span>
    </div>
    <div class="info-row">
      <span class="label">Mother Total:</span>
      <span>${motherTotal}</span>
    </div>
    <div class="info-row">
      <span class="label">Combined Total:</span>
      <span>${combinedTotal}</span>
    </div>
    <div class="info-row">
      <span class="label">Dhikr Repetitions:</span>
      <span>${repetitionCount}</span>
    </div>
  </div>

  <h2>Personality</h2>
  <p><strong>Temperament:</strong> ${burujProfile.personality.temperament}</p>
  <p><strong>Communication:</strong> ${burujProfile.personality.communication}</p>

  <h2>Career Guidance</h2>
  <p><strong>Categories:</strong> ${burujProfile.career.categories.join(', ')}</p>
  <p><strong>Recommended Industries:</strong></p>
  <ul>
    ${burujProfile.career.recommended_industries.map(i => `<li>${i}</li>`).join('')}
  </ul>

  <h2>Blessed Day</h2>
  <p><strong>Day:</strong> ${burujProfile.blessed_day.day}</p>
  <p><strong>Prophet:</strong> ${burujProfile.blessed_day.prophet}</p>

  <h2>Spiritual Practices</h2>
  <p><strong>Divine Names:</strong> ${burujProfile.spiritual_practices.divine_names.join(', ')}</p>
  <p><strong>Dhikr Count:</strong> ${repetitionCount} repetitions</p>
  <p><strong>Timing:</strong> ${burujProfile.spiritual_practices.timing}</p>

  <hr style="margin-top: 40px;">
  <p style="text-align: center; color: #8892b0; font-size: 12px;">
    Generated by AsrƒÅr Everyday ‚Ä¢ ${new Date().toLocaleString()}
  </p>
</body>
</html>
  `.trim();
}

const styles = StyleSheet.create({
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#0f1419',
  },
  loadingText: {
    fontSize: 16,
    color: '#ffffff',
  },
  headerButtons: {
    flexDirection: 'row',
    marginRight: 8,
  },
  headerButton: {
    padding: 8,
    marginLeft: 8,
  },
  headerButtonText: {
    fontSize: 22,
  },
});
